"use strict";!function(){function e(e){var n=document.getElementById("body");n.scrollTop=n.scrollHeight;var t=document.getElementById("conversation-box");t.scrollTop=t.scrollHeight}window.onresize=e,window.onbeforeunload=function(){return"Are you sure you want to leave?"}}(),window.chatBox=function(){function e(e){var n=c.attr("data-current");e===!0?(c.text("next"),c.attr("data-current","next"),c.removeClass("red")):"start"===n||"really"===n?(c.text("next"),c.attr("data-current","next"),c.removeClass("red"),chatClient.nextPartner()):(c.text("really?"),c.attr("data-current","really"),c.addClass("red"))}function n(e){e?$(".chat").removeClass("text-only"):$(".chat").addClass("text-only")}function t(){i.html(""),s.html("")}function o(){var n=s.val();if(chatClient.sendMessage(n)){var t=document.createTextNode(" "+n),o=$('<p class="userlog me"></p>');o.append('<span class="name">You</span>'),o.append(t),i.append(o),i.scrollTop(i.prop("scrollHeight")),s.val(""),e(!0)}}function a(e){var n=$('<div class="sys-info"></div>');switch(e){case"partner_connected":chatBox.clear(),n.append('<p class="syslog"><strong>You\'re now chatting with a random stranger. Say hi!</strong></p>');break;case"waiting_partner":n.append('<p class="syslog"><strong>Looking for someone you can talk to...</strong></p>');break;case"partner_disconnected":n.append('<p class="syslog"><strong>Sorry. stranger has disconnected.</strong></p>'),n.append('<p class="syslog"><strong>Click on <span class="special">next</span> to start a new chat.</strong></p>');break;default:n.append(e)}i.append(n),i.scrollTop(i.prop("scrollHeight"))}function r(e){var n=document.createTextNode(" "+e.content),t=$('<p class="userlog stranger"></p>');t.append('<span class="name">Stranger</span>'),t.append(n),i.append(t),i.scrollTop(i.prop("scrollHeight"))}var i=$(".conversation-box"),s=$(".write-box>textarea"),c=$("#control");return $(".write-box>.btn").on("click",o),c.on("click",e),s.on("keydown",function(e){13==e.which&&o()}),$(document).on("keyup",function(e){27==e.which&&c.click()}),{clear:t,writePartnerMessage:r,writeSytemInfo:a,changeChatMode:n}}(),window.chatClient=function(){function e(){chatBox.clear(),t(),$(".video>.stranger>video").remove(),l.emit("next")}function n(){l.emit("info",{isVideoChat:p})}function t(){d=!1,f&&f.destroy&&f.destroy(),f=null,u=!1,$(".video>.stranger").removeClass("loading")}function o(){navigator.mediaDevices.getUserMedia({video:!0,audio:!0}).then(function(e){g=e,p=!0,n(),chatBox.changeChatMode(!0);var t=$("<video>");$(".video>.me").html(""),$(".video>.me").append(t),t.attr("src",window.URL.createObjectURL(g)),t[0].play()}).catch(function(e){g=null,p=!1,n(),chatBox.changeChatMode(!1)})}function a(e){switch(e){case"partner_connected":d=!0,$(".video>.stranger").addClass("loading");break;case"partner_disconnected":t();break;case"waiting_partner":n(),d=!1}chatBox.writeSytemInfo(e)}function r(e){return!!(d&&e.replace(/\s+/g,"").length>0)&&(l.emit("msg",e),!0)}function i(){if(console.log("handleVideoInit"),!p||!g)return l.emit("videochat_init",!1);var e={initiator:!0,stream:g,trickle:!1};f=new SimplePeer(e),f.on("signal",function(e){console.log("sending signal..."),l.emit("videochat_init",e)}),f.on("stream",function(e){if(u)return!1;u=!0;var n=$("<video>");$(".video>.stranger>video").remove(),$(".video>.stranger").append(n),n.attr("src",window.URL.createObjectURL(e)),setTimeout(function(){n[0].paused&&n[0].play()},200)})}function s(e){if(console.log("handleVideoOffer"),!p||!g)return l.emit("videochat_offer_ok",!1);var n={stream:g,trickle:!1};f=new SimplePeer(n),f.signal(e),f.on("signal",function(e){console.log("sending signal..."),l.emit("videochat_offer_ok",e)}),f.on("stream",function(e){if(u)return!1;u=!0;var n=$("<video>");$(".video>.stranger>video").remove(),$(".video>.stranger").append(n),n.attr("src",window.URL.createObjectURL(e)),setTimeout(function(){n[0].paused&&n[0].play()},200)})}function c(e){console.log("handleVideoOfferResponse"),f&&f.signal(e)}var l=io("https://192.168.0.16/"),d=!1,p=!1,u=!1,g=null,f=void 0;return l.on("msg",chatBox.writePartnerMessage),l.on("sysinfo",a),l.on("videochat_init",i),l.on("videochat_offer",s),l.on("videochat_offer_response",c),o(),{sendMessage:r,nextPartner:e}}();