"use strict";!function(){function e(e){var n=document.getElementById("body");n.scrollTop=n.scrollHeight;var t=document.getElementById("conversation-box");t.scrollTop=t.scrollHeight}window.onresize=e,window.onbeforeunload=function(){return"Are you sure you want to leave?"}}(),window.chatBox=function(){function e(e){var n=i.attr("data-current");e===!0?(i.text("next"),i.attr("data-current","next"),i.removeClass("red")):"start"===n||"really"===n?(i.text("next"),i.attr("data-current","next"),i.removeClass("red"),chatClient.nextPartner()):(i.text("really?"),i.attr("data-current","really"),i.addClass("red"))}function n(e){e?$(".chat").removeClass("text-only"):$(".chat").addClass("text-only")}function t(){c.html(""),s.html("")}function o(){var n=s.val();if(chatClient.sendMessage(n)){var t=document.createTextNode(" "+n),o=$('<p class="userlog me"></p>');o.append('<span class="name">You</span>'),o.append(t),c.append(o),c.scrollTop(c.prop("scrollHeight")),s.val(""),e(!0)}}function a(e){var n=$('<div class="sys-info"></div>');switch(e){case"partner_connected":chatBox.clear(),n.append('<p class="syslog"><strong>You\'re now chatting with a random stranger. Say hi!</strong></p>');break;case"waiting_partner":n.append('<p class="syslog"><strong>Looking for someone you can talk to...</strong></p>');break;case"partner_disconnected":n.append('<p class="syslog"><strong>Sorry. stranger has disconnected.</strong></p>'),n.append('<p class="syslog"><strong>Click on <span class="special">next</span> to start a new chat.</strong></p>');break;case"server_disconnection":n.append('<p class="syslog error"><strong>System error! Please refresh this page!</strong></p>');break;default:n.append(e)}c.append(n),c.scrollTop(c.prop("scrollHeight"))}function r(e){var n=document.createTextNode(" "+e.content),t=$('<p class="userlog stranger"></p>');t.append('<span class="name">Stranger</span>'),t.append(n),c.append(t),c.scrollTop(c.prop("scrollHeight"))}var c=$(".conversation-box"),s=$(".write-box>textarea"),i=$("#control");return $(".write-box>.btn").on("click",o),i.on("click",e),s.on("keydown",function(e){13==e.which&&o()}),$(document).on("keyup",function(e){27==e.which&&i.click()}),{clear:t,writePartnerMessage:r,writeSytemInfo:a,changeChatMode:n}}(),window.chatClient=function(){function e(){chatBox.clear(),o(),$(".video>.stranger>video").remove(),u.emit("next")}function n(){u.emit("info",{isVideoChat:h})}function t(){r("server_disconnection")}function o(){f=!1,m&&m.destroy&&m.destroy(),m=null,g=!1,$(".video>.stranger").removeClass("loading")}function a(){navigator.mediaDevices.getUserMedia({video:!0,audio:!0}).then(function(e){v=e,h=!0,n(),chatBox.changeChatMode(!0);var t=$("<video>");$(".video>.me").html(""),$(".video>.me").append(t),t.attr("src",window.URL.createObjectURL(v)),t[0].play()}).catch(function(e){v=null,h=!1,n(),chatBox.changeChatMode(!1)})}function r(e){switch(e){case"partner_connected":f=!0,$(".video>.stranger").addClass("loading");break;case"partner_disconnected":o();break;case"waiting_partner":n(),f=!1}chatBox.writeSytemInfo(e)}function c(e){return!!(f&&e.replace(/\s+/g,"").length>0)&&(u.emit("msg",e),!0)}function s(){return h&&v?(d(),void m.offer(function(e,n){u.emit("videochat_init",n)})):u.emit("videochat_init",!1)}function i(e){return h&&v?(d(),void m.handleOffer(e,function(e){e||m.answer(function(e,n){e||u.emit("videochat_offer_ok",n)})})):u.emit("videochat_offer_ok",!1)}function d(){m=new PeerConnection,m.addStream(v),m.on("addStream",function(e){var n=e.stream;if(g)return!1;g=!0;var t=$("<video>");$(".video>.stranger>video").remove(),$(".video>.stranger").append(t),t.attr("src",window.URL.createObjectURL(n)),setTimeout(function(){t[0].paused&&t[0].play()},200)}),m.on("ice",function(e){u.emit("videochat_ice",e)})}function l(e){m&&m.handleAnswer(e)}function p(e){m&&m.processIce(e)}var u=io("https://192.168.0.16/"),f=!1,h=!1,g=!1,v=null,m=void 0;return u.on("msg",chatBox.writePartnerMessage),u.on("sysinfo",r),u.on("videochat_init",s),u.on("videochat_offer",i),u.on("videochat_offer_response",l),u.on("videochat_ice",p),u.on("disconnect",t),a(),{sendMessage:c,nextPartner:e}}();