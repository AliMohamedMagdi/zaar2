"use strict";!function(){function e(e){var t=document.getElementById("body");t.scrollTop=t.scrollHeight;var n=document.getElementById("conversation-box");n.scrollTop=n.scrollHeight}window.onresize=e,window.onbeforeunload=function(){return"Are you sure you want to leave?"}}(),window.chatBox=function(){function e(e){var t=s.attr("data-current");e===!0?(s.text("next"),s.attr("data-current","next"),s.removeClass("red")):"start"===t||"really"===t?(s.text("next"),s.attr("data-current","next"),s.removeClass("red"),chatClient.nextPartner()):(s.text("really?"),s.attr("data-current","really"),s.addClass("red"))}function t(e){e?$(".chat").removeClass("text-only"):$(".chat").addClass("text-only")}function n(){i.html(""),c.html("")}function o(){var t=c.val();if(chatClient.sendMessage(t)){var n=document.createTextNode(" "+t),o=$('<p class="userlog me"></p>');o.append('<span class="name">You</span>'),o.append(n),i.append(o),i.scrollTop(i.prop("scrollHeight")),c.val(""),e(!0)}}function a(e){var t=$('<div class="sys-info"></div>');switch(e){case"partner_connected":chatBox.clear(),t.append('<p class="syslog"><strong>You\'re now chatting with a random stranger. Say hi!</strong></p>');break;case"waiting_partner":t.append('<p class="syslog"><strong>Looking for someone you can talk to...</strong></p>');break;case"partner_disconnected":t.append('<p class="syslog"><strong>Sorry. stranger has disconnected.</strong></p>'),t.append('<p class="syslog"><strong>Click on <span class="special">next</span> to start a new chat.</strong></p>');break;default:t.append(e)}i.append(t)}function r(e){var t=document.createTextNode(" "+e.content),n=$('<p class="userlog stranger"></p>');n.append('<span class="name">Stranger</span>'),n.append(t),i.append(n),i.scrollTop(i.prop("scrollHeight"))}var i=$(".conversation-box"),c=$(".write-box>textarea"),s=$("#control");return $(".write-box>.btn").on("click",o),s.on("click",e),$(".logo").on("click",function(){return window.location.reload()}),c.on("keydown",function(e){13==e.which&&o()}),$(document).on("keyup",function(e){27==e.which&&s.click()}),{clear:n,writePartnerMessage:r,writeSytemInfo:a,changeChatMode:t}}(),window.chatClient=function(){function e(){chatBox.clear(),l=!1,f=null,p=!1,$(".video>.stranger").html(""),s.emit("next")}function t(){s.emit("info",{isVideoChat:d})}function n(){navigator.mediaDevices.getUserMedia({video:!0,audio:!0}).then(function(e){u=e,d=!0,t(),chatBox.changeChatMode(!0);var n=$("<video>");$(".video>.me").html(""),$(".video>.me").append(n),n.attr("src",window.URL.createObjectURL(u)),n[0].play()}).catch(function(e){u=null,d=!1,t(),chatBox.changeChatMode(!1)})}function o(e){switch(e){case"partner_connected":l=!0;break;case"partner_disconnected":l=!1;break;case"waiting_partner":t(),l=!1}chatBox.writeSytemInfo(e)}function a(e){return!!(l&&e.replace(/\s+/g,"").length>0)&&(s.emit("msg",e),!0)}function r(){if(!d||!u)return s.emit("videochat_init",!1);var e={initiator:!0,trickle:!1,stream:u};f=new SimplePeer(e),f.on("signal",function(e){return s.emit("videochat_init",e)}),f.on("stream",function(e){if(p)return!1;p=!0;var t=$("<video>");$(".video>.stranger").html(""),$(".video>.stranger").append(t),t.attr("src",window.URL.createObjectURL(e)),setTimeout(function(){t[0].paused&&t[0].play()},200)})}function i(e){if(!d||!u)return s.emit("videochat_offer_ok",!1);var t={trickle:!1,stream:u};f=new SimplePeer(t),f.signal(e),f.on("signal",function(e){return s.emit("videochat_offer_ok",e)}),f.on("stream",function(e){if(p)return!1;p=!0;var t=$("<video>");$(".video>.stranger").html(""),$(".video>.stranger").append(t),t.attr("src",window.URL.createObjectURL(e)),setTimeout(function(){t[0].paused&&t[0].play()},200)})}function c(e){f&&(console.log("videoOfferResponse",e),f.signal(e))}var s=io("https://192.168.0.16/"),l=!1,d=!1,p=!1,u=null,f=void 0;return s.on("msg",chatBox.writePartnerMessage),s.on("sysinfo",o),s.on("videochat_init",r),s.on("videochat_offer",i),s.on("videochat_offer_response",c),n(),{sendMessage:a,nextPartner:e}}();